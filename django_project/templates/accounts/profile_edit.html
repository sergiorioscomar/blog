{% extends "base.html" %}
{% load static %}
{% load form_tags %}
{% block title %}Editar perfil{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 920px;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Editar perfil</h2>
      <small class="text-muted">Actualiza tu información y tu avatar</small>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="card shadow-sm border-0 rounded-3">
    {% csrf_token %}

    <div class="card-body">
      <div class="row g-4">
        <!-- Columna Avatar -->
        <div class="col-md-4">
          <div class="text-center">
            <div class="position-relative d-inline-block">
              {% if request.user.profile.avatar %}
                <img id="avatarPreview"
                     src="{{ request.user.profile.avatar.url }}"
                     class="rounded-circle shadow-sm"
                     style="width: 160px; height:160px; object-fit: cover;"
                     alt="Avatar">
              {% else %}
                <img id="avatarPreview"
                     src="{% static 'img/avatar-default.png' %}"
                     class="rounded-circle shadow-sm"
                     style="width: 160px; height:160px; object-fit: cover;"
                     alt="Avatar">
              {% endif %}
              <!-- Botón flotante para cambiar -->
              <label for="id_avatar"
                     class="btn btn-sm btn-dark position-absolute bottom-0 end-0 translate-middle-y rounded-pill px-3">
                Cambiar
              </label>
            </div>

            <!-- Input de archivo (oculto visualmente, pero accesible) -->
            <div class="mt-3">
              {{ pform.avatar.as_widget|safe }}
              <div class="form-text">PNG/JPG, máx. 2&nbsp;MB</div>
            </div>

            <!-- “Quitar avatar”: replica el checkbox que renderiza Django -->
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="clearAvatarSwitch" name="avatar-clear">
              <label class="form-check-label" for="clearAvatarSwitch">Quitar avatar</label>
            </div>
          </div>
        </div>

        <!-- Columna Datos -->
        <div class="col-md-8">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ uform.first_name.label }}</label>
              {{ uform.first_name|add_class:"form-control"  }}
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ uform.last_name.label }}</label>
              {{ uform.last_name|add_class:"form-control" }}
            </div>
            <div class="col-md-12">
              <label class="form-label">{{ uform.email.label }}</label>
              {{ uform.email|add_class:"form-control" }}
            </div>
            <div class="col-md-12">
              <label class="form-label">{{ pform.bio.label }}</label>
              {{ pform.bio|add_class:"form-control" }}
              <div class="form-text">Una breve descripción sobre ti.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ pform.website.label }}</label>
              {{ pform.website|add_class:"form-control" }}
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ pform.github.label }}</label>
              {{ pform.github|add_class:"form-control" }}
            </div>
            <div class="text-end mt-3">
                <a href="{% url 'password_change' %}" class="btn btn-outline-warning">
                    Cambiar contraseña
                </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center bg-white">
      <a class="btn btn-outline-secondary" href="{% url 'dashboard' %}">Cancelar</a>
      <button class="btn btn-primary" type="submit">Guardar cambios</button>
    </div>
  </form>
</div>

<script>
  // Vista previa del avatar y manejo de “Quitar avatar”
  (function () {
    const fileInput = document.getElementById('id_avatar');
    const preview   = document.getElementById('avatarPreview');
    const clearSw   = document.getElementById('clearAvatarSwitch');

    if (fileInput) {
      // Asegura clases de Bootstrap al input file si tu form no las trae
      fileInput.classList.add('form-control');
      fileInput.setAttribute('accept', 'image/*');

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          if (clearSw) clearSw.checked = false; // si sube nuevo, no borrar
        };
        reader.readAsDataURL(file);
      });
    }

    if (clearSw) {
      clearSw.addEventListener('change', () => {
        if (clearSw.checked) {
          // Si elige “Quitar”, limpiamos el file input y mostramos el default
          if (fileInput) fileInput.value = '';
          {% if request.user.profile.avatar %}
            // Si quieres mostrar un placeholder al limpiar:
            preview.src = "{% static 'img/avatar-default.png' %}";
          {% endif %}
        }
      });
    }
  })();
</script>
{% endblock %}
